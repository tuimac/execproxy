version: 2.1
executors:
  awscli:
    docker:
      - image: amazon/aws-cli
    environment:
      AWS_DEFAULT_REGION: ap-northeast-1
      AWS_PAGER: ""
jobs:
  build:
    machine:
      image: ubuntu-2004:202010-01
    environment:
      - IMAGENAME: execproxy
      - CI: ""
    steps:
      - checkout
      - run:
          name: Install tools
          command: |
            sudo apt update
            sudo apt install -y nodejs npm python3
            sudo npm install n -g
            sudo n stable
            sudo apt purge -y nodejs npm
            npm install -g @angular/cli
            sudo curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            node --version
            npm --version
            python3 -V
      - run:
          name: Build Frontend Application
          working_directory: frontend
          command: |
            npm install
            npm run build
            cp -rp dist/frontend ../docker/build/
      - run:
          name: Prepare Backend Application
          command: cp -rp backend docker/build/
      - run:
          name: Build Frontend Docker Image
          working_directory: docker/build
          command: docker build -t ${DOCKER_USER}/${IMAGENAME}:${CIRCLE_SHA1} .
      - run:
          name: Run Containers
          command: |
            docker run -itd \
              -p 80:80 \
              -p 8000:8000 \
              --network bridge \
              ${DOCKER_USER}/${IMAGENAME}:${CIRCLE_SHA1} \
              bash
workflows:
  version: 2.1
  execproxy-pipeline:
    jobs:
      - build
